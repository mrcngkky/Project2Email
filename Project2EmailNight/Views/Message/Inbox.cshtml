@model List<Project2EmailNight.Entities.Message>

@{
    ViewData["Title"] = "Mesajlar";
    Layout = "~/Views/Shared/_Layout.cshtml";
    string pageTitle = Context.Request.Path.Value.Contains("Sendbox") ? "Giden Kutusu" : "Gelen Kutusu";
}

<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">

<style>
    
    .email-app-container {
        display: flex;
        height: calc(100vh - 70px);
        width: 100%;
        overflow: hidden;
        background-color: #fff;
    }

    /* SOL MENÜ (SIDEBAR) */
    .email-sidebar {
        width: 260px;
        flex-shrink: 0;
        border-right: 1px solid #eef2f7;
        display: flex;
        flex-direction: column;
        background-color: #fff;
        height: 100%;
        overflow-y: auto;
    }

    /* SAĞ İÇERİK (MAIN CONTENT) */
    .email-content-wrapper {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        background-color: #fff;
    }

    .email-list-scroll {
        flex-grow: 1;
        overflow-y: auto;
    }

    /* --- TASARIM DETAYLARI --- */
    :root {
        --primary-purple: #673ab7;
        --light-purple: #ede7f6;
    }

    .btn-purple {
        background-color: var(--primary-purple);
        color: white;
        border: none;
    }

        .btn-purple:hover {
            background-color: #5e35b1;
            color: white;
        }

    /* Sidebar Linkleri */
    .sidebar-link {
        color: #5f6368;
        font-weight: 500;
        border: none;
        padding: 10px 20px;
        border-radius: 0 50px 50px 0;
        margin-right: 15px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        text-decoration: none;
    }

        .sidebar-link:hover {
            background-color: #f1f3f4;
            color: #000;
        }

        .sidebar-link.active {
            background-color: var(--light-purple);
            color: var(--primary-purple);
            font-weight: 700;
        }

    
    .email-row {
        height: 56px;
        border-bottom: 1px solid #f1f3f4;
        cursor: pointer;
        transition: background 0.1s;
    }

        .email-row:hover {
            background-color: #f8f9fa;
            box-shadow: inset 1px 0 0 #dadce0, inset -1px 0 0 #dadce0, 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);
            z-index: 2;
            position: relative;
        }

    .unread {
        background-color: #fff;
        font-weight: 700;
        color: #202124;
    }

    .read {
        background-color: rgba(242,245,245,0.8);
        font-weight: 400;
        color: #5f6368;
    }

    /* Rozetler - DÜZELTİLDİ */
    .badge-soft {
        padding: 3px 10px;
        font-size: 11px;
        border-radius: 10px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        box-shadow: 0 1px 2px rgba(0,0,0,0.15);
        height: 20px;
        vertical-align: middle;
        line-height: 1;
    }

    /* Renkleri daha güçlü yap */
    .bg-soft-purple {
        background: #673ab7;
        color: #fff;
    }

    .bg-soft-warning {
        background: #ff9800;
        color: #fff;
    }

    .bg-soft-danger {
        background: #e53935;
        color: #fff;
    }

    .bg-soft-primary {
        background: #1976d2;
        color: #fff;
    }

    .bg-soft-secondary {
        background: #9e9e9e;
        color: #fff;
    }


    /* Arama */
    .search-box {
        background: #f1f3f4;
        border-radius: 8px;
        border: none;
        transition: 0.3s;
    }

        .search-box:focus {
            background: #fff;
            box-shadow: 0 1px 1px 0 rgba(65,69,73,0.3), 0 1px 3px 1px rgba(65,69,73,0.15);
        }

    /* Dosya listesi */
    .attachment-item {
        display: inline-flex;
        align-items: center;
        background: #f1f3f4;
        padding: 6px 12px;
        border-radius: 16px;
        margin: 4px;
        font-size: 13px;
    }

        .attachment-item i {
            margin-right: 6px;
        }

    .remove-attachment {
        cursor: pointer;
        margin-left: 8px;
        color: #d32f2f;
    }

    /* Pagination */
    .pagination .page-link {
        color: var(--primary-purple);
        border: 1px solid #dee2e6;
    }

    .pagination .page-item.active .page-link {
        background-color: var(--primary-purple);
        border-color: var(--primary-purple);
    }
</style>

<div class="email-app-container">

    <div class="email-sidebar py-3">
        <div class="px-3 mb-3">
            <button type="button" class="btn btn-purple w-100 py-2 shadow-sm rounded-pill fw-bold" data-bs-toggle="modal" data-bs-target="#composeModal">
                <i class='bx bx-plus me-2'></i>Oluştur
            </button>
        </div>

        <a href="/Message/Inbox?filter=all" class="sidebar-link @(ViewBag.CurrentFilter == "all" ? "active" : "")">
            <i class='bx bxs-inbox me-3 font-20'></i><span>Gelen Kutusu</span>
            @if (ViewBag.CurrentFilter == "all")
            {
                <span class="ms-auto small fw-bold unread-badge">@ViewBag.UnreadCount</span>
            }
        </a>

        <a href="/Message/Inbox?filter=starred" class="sidebar-link @(ViewBag.CurrentFilter == "starred" ? "active" : "")">
            <i class='bx bx-star me-3 font-20'></i><span>Yıldızlı</span>
        </a>

        <a href="/Message/Inbox?filter=snoozed" class="sidebar-link @(ViewBag.CurrentFilter == "snoozed" ? "active" : "")">
            <i class='bx bx-time-five me-3 font-20'></i><span>Ertelenenler</span>
        </a>

        <a href="/Message/Sendbox" class="sidebar-link @(ViewBag.CurrentFilter == "sent" ? "active" : "")">
            <i class='bx bxs-send me-3 font-20'></i><span>Gönderilmiş</span>
        </a>

        <a href="/Message/Inbox?filter=drafts" class="sidebar-link @(ViewBag.CurrentFilter == "drafts" ? "active" : "")">
            <i class='bx bxs-file-blank me-3 font-20'></i><span>Taslaklar</span>
        </a>

        <div class="mt-3 mb-2 px-4 small fw-bold text-muted">KATEGORİLER</div>
        <a href="javascript:;" class="sidebar-link"><i class='bx bxs-label me-3 text-primary'></i><span>İş</span></a>
        <a href="javascript:;" class="sidebar-link"><i class='bx bxs-label me-3 text-warning'></i><span>Eğitim</span></a>
        <a href="javascript:;" class="sidebar-link"><i class='bx bxs-label me-3 text-danger'></i><span>Acil</span></a>
        <a href="javascript:;" class="sidebar-link"><i class='bx bxs-label me-3 text-success'></i><span>Sosyal</span></a>
    </div>

    <div class="email-content-wrapper">

        <div class="d-flex align-items-center justify-content-between px-3 py-2 border-bottom" style="height: 64px;">

            <form action="/Message/Inbox" method="get" class="flex-grow-1 me-4" style="max-width: 600px;">
                <input type="hidden" name="filter" value="@ViewBag.CurrentFilter">
                <div class="input-group">
                    <span class="input-group-text bg-transparent border-0"><i class='bx bx-search font-20 text-muted'></i></span>
                    <input type="text" name="search" class="form-control search-box" placeholder="E-postalarda arayın" value="@ViewBag.SearchTerm">
                </div>
            </form>

            <div class="d-flex align-items-center gap-2">
                <button id="btnBulkDelete" class="btn btn-danger btn-sm px-3 d-none" onclick="deleteSelected()">
                    <i class='bx bx-trash me-1'></i> Sil (<span id="selectedCount">0</span>)
                </button>

                <button class="btn btn-light btn-sm rounded-circle p-2" onclick="location.reload()" title="Yenile">
                    <i class='bx bx-refresh font-20 text-muted'></i>
                </button>

                @{
                    int currentPage = Convert.ToInt32(ViewBag.CurrentPage ?? 1);
                    int totalPages = Convert.ToInt32(ViewBag.TotalPages ?? 1);
                }

                <div class="d-flex align-items-center ms-3 small">

                    <a href="/Message/Inbox?page=@(currentPage - 1)&filter=@ViewBag.CurrentFilter&search=@ViewBag.SearchTerm"
                       class="btn btn-outline-secondary btn-sm me-2 @(currentPage == 1 ? "disabled" : "")">
                        <i class='bx bx-chevron-left'></i> Önceki
                    </a>

                    <span class="mx-2 text-muted">
                        Sayfa @currentPage / @totalPages
                    </span>

                    <a href="/Message/Inbox?page=@(currentPage + 1)&filter=@ViewBag.CurrentFilter&search=@ViewBag.SearchTerm"
                       class="btn btn-outline-secondary btn-sm ms-2 @(currentPage == totalPages ? "disabled" : "")">
                        Sonraki <i class='bx bx-chevron-right'></i>
                    </a>

                </div>

            </div>
        </div>

        <div class="d-flex align-items-center px-3 py-2 border-bottom bg-white">
            <div class="form-check ms-1">
                <input class="form-check-input" type="checkbox" id="selectAll">
            </div>
            <button class="btn btn-light btn-sm ms-3" title="Yenile" onclick="location.reload()">
                <i class='bx bx-refresh font-18'></i>
            </button>
            <button class="btn btn-light btn-sm ms-1" title="Okundu İşaretle" onclick="markSelectedAsRead()">
                <i class='bx bx-envelope-open font-18'></i>
            </button>
        </div>

        <div class="email-list-scroll">
            @foreach (var item in Model)
            {
                <div class="d-flex align-items-center email-row px-3 @(item.IsStatus ? "read" : "unread")"
                     onclick="window.location='/Message/Details/@item.MessageId'">

                    <div class="d-flex align-items-center" style="width: 80px;" onclick="event.stopPropagation()">
                        <div class="form-check mb-0 ms-1">
                            <input class="form-check-input message-checkbox" type="checkbox" value="@item.MessageId" onchange="updateBulkActions()">
                        </div>
                        <i class='bx @(item.IsStarred ? "bxs-star text-warning" : "bx-star text-muted") font-20 ms-3 star-icon'
                           onclick="toggleStar(this, @item.MessageId)"></i>
                    </div>

                    <div class="d-flex align-items-center flex-grow-1 text-truncate pe-3">

                        <span class="text-truncate fw-bold text-dark me-2" style="font-size: 14px; min-width: 150px; max-width: 250px;">
                            @(string.IsNullOrEmpty(item.Subject) ? "(Konu yok)" : item.Subject)
                        </span>

                        <!-- TEK BADGE - DÜZELTİLDİ -->
                        <span class="badge-soft bg-soft-@(item.Category == "İş" ? "purple" : item.Category == "Acil" ? "danger" : item.Category == "Eğitim" ? "warning" : item.Category == "Sosyal" ? "primary" : "secondary") me-3" style="flex-shrink:0;">
                            @item.Category
                        </span>

                        @if (item.Attachments != null && item.Attachments.Count > 0)
                        {
                            <i class='bx bx-paperclip me-2 text-muted'></i>
                        }

                    
                        
                        <span class="text-muted text-truncate small" style="max-width: 600px;">
                            @{
                                var plainText = item.MessageDetail ?? "";
                                
                                plainText = System.Text.RegularExpressions.Regex.Replace(plainText, "<.*?>", "");
                                
                                plainText = System.Text.RegularExpressions.Regex.Replace(plainText, @"\s+", " ").Trim();
                            }
                            @(plainText.Length > 100 ? plainText.Substring(0, 100) + "..." : plainText)
                        </span>

                    </div>

                    <div class="text-end small fw-bold" style="width: 100px; font-size: 12px;">
                        @item.SendDate.ToString("d MMM")
                    </div>
                </div>
            }

            @if (Model.Count == 0)
            {
                <div class="d-flex flex-column align-items-center justify-content-center h-50">
                    <div class="bg-light rounded-circle p-4 mb-3"><i class='bx bx-inbox font-30 text-muted'></i></div>
                    <p class="text-muted">Mesaj bulunamadı.</p>
                </div>
            }
        </div>

        
        @if (ViewBag.TotalPages > 1)
        {
            <div class="d-flex justify-content-center align-items-center py-3 border-top">
                <nav>
                    <ul class="pagination mb-0">
                        <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
                            <a class="page-link" href="/Message/Inbox?page=1&search=@ViewBag.SearchTerm&filter=@ViewBag.CurrentFilter">
                                <i class='bx bx-chevrons-left'></i>
                            </a>
                        </li>

                        <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
                            <a class="page-link" href="/Message/Inbox?page=@(ViewBag.CurrentPage - 1)&search=@ViewBag.SearchTerm&filter=@ViewBag.CurrentFilter">
                                <i class='bx bx-chevron-left'></i>
                            </a>
                        </li>

                        @for (int i = Math.Max(1, ViewBag.CurrentPage - 2); i <= Math.Min(ViewBag.TotalPages, ViewBag.CurrentPage + 2); i++)
                        {
                            <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                <a class="page-link" href="/Message/Inbox?page=@i&search=@ViewBag.SearchTerm&filter=@ViewBag.CurrentFilter">@i</a>
                            </li>
                        }

                        <li class="page-item @(ViewBag.CurrentPage == ViewBag.TotalPages ? "disabled" : "")">
                            <a class="page-link" href="/Message/Inbox?page=@(ViewBag.CurrentPage + 1)&search=@ViewBag.SearchTerm&filter=@ViewBag.CurrentFilter">
                                <i class='bx bx-chevron-right'></i>
                            </a>
                        </li>

                        <li class="page-item @(ViewBag.CurrentPage == ViewBag.TotalPages ? "disabled" : "")">
                            <a class="page-link" href="/Message/Inbox?page=@ViewBag.TotalPages&search=@ViewBag.SearchTerm&filter=@ViewBag.CurrentFilter">
                                <i class='bx bx-chevrons-right'></i>
                            </a>
                        </li>
                    </ul>
                </nav>

                <div class="ms-3 text-muted small">
                    Sayfa @ViewBag.CurrentPage / @ViewBag.TotalPages (@ViewBag.TotalMessages mesaj)
                </div>
            </div>
        }
    </div>
</div>


<div class="modal fade" id="composeModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-dark text-white py-2">
                <h6 class="modal-title">Yeni İleti</h6>
                <span id="draftStatus" class="ms-3 small text-success" style="display:none;"></span>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="composeForm" action="/Message/SendMessage" method="post" enctype="multipart/form-data">
                <input type="hidden" name="DraftId" id="draftIdInput" value="">

                <div class="modal-body p-0">
                    <input type="email" name="ReceiverEmail" class="form-control border-0 border-bottom rounded-0 p-3"
                           placeholder="Alıcı" required>
                    <input type="text" name="Subject" class="form-control border-0 border-bottom rounded-0 p-3"
                           placeholder="Konu" required>
                    <textarea id="summernote" name="MessageDetail"></textarea>

                    
                    <div class="p-3 border-top">
                        <label class="btn btn-light btn-sm">
                            <i class='bx bx-paperclip me-1'></i> Dosya Ekle
                            <input type="file" id="attachmentInput" name="Attachments" multiple
                                   style="display:none;" onchange="displayAttachments()">
                        </label>
                        <div id="attachmentList" class="mt-2"></div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="submit" class="btn btn-primary px-4 rounded-pill">
                        <i class='bx bx-send me-1'></i> Gönder
                    </button>
                    <button type="button" class="btn btn-light px-4 rounded-pill" onclick="saveDraftManually()">
                        <i class='bx bx-save me-1'></i> Taslak Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
    <script>
        let draftTimer;
        let currentDraftId = null;
        let isDraftSaving = false;

        $(document).ready(function() {
            
            $('#summernote').summernote({
                placeholder: 'Bir şeyler yazın...',
                tabsize: 2,
                height: 200,
                toolbar: [
                    ['style', ['bold', 'italic', 'underline', 'clear']],
                    ['para', ['ul', 'ol']],
                    ['insert', ['link']]
                ],
                disableResizeEditor: true
            });

           
            $('#selectAll').change(function() {
                $('.message-checkbox').prop('checked', $(this).prop('checked'));
                updateBulkActions();
            });

            
            $('[name="ReceiverEmail"], [name="Subject"]').on('input', autoSaveDraft);
            $('#summernote').on('summernote.change', autoSaveDraft);
        });

        
        function autoSaveDraft() {
            clearTimeout(draftTimer);

            draftTimer = setTimeout(() => {
                if (isDraftSaving) return;

                const receiverEmail = $('[name="ReceiverEmail"]').val();
                const subject = $('[name="Subject"]').val();
                const messageDetail = $('#summernote').summernote('code');

                if (!subject && !messageDetail) return;

                isDraftSaving = true;

                const formData = new FormData();
                formData.append('ReceiverEmail', receiverEmail || '');
                formData.append('Subject', subject || '(Konu yok)');
                formData.append('MessageDetail', messageDetail);
                if (currentDraftId) formData.append('DraftId', currentDraftId);

                const attachments = $('#attachmentInput')[0].files;
                for (let i = 0; i < attachments.length; i++) {
                    formData.append('Attachments', attachments[i]);
                }

                fetch('/Message/SaveDraft', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentDraftId = data.draftId;
                        $('#draftIdInput').val(currentDraftId);
                        $('#draftStatus').text('Taslak kaydedildi ✓').fadeIn().delay(2000).fadeOut();
                    }
                })
                .finally(() => {
                    isDraftSaving = false;
                });
            }, 3000);
        }

        
        function saveDraftManually() {
            clearTimeout(draftTimer);
            autoSaveDraft();
        }

        
        function displayAttachments() {
            const input = document.getElementById('attachmentInput');
            const listDiv = document.getElementById('attachmentList');
            listDiv.innerHTML = '';

            for (let i = 0; i < input.files.length; i++) {
                const file = input.files[i];
                const fileSize = (file.size / 1024).toFixed(2);

                const fileDiv = document.createElement('div');
                fileDiv.className = 'attachment-item';
                fileDiv.innerHTML = `
                    <i class='bx bx-file'></i>
                    ${file.name} (${fileSize} KB)
                    <i class='bx bx-x remove-attachment' onclick="removeAttachment(${i})"></i>
                `;
                listDiv.appendChild(fileDiv);
            }

            autoSaveDraft();
        }

        // Dosya silme
        function removeAttachment(index) {
            const input = document.getElementById('attachmentInput');
            const dt = new DataTransfer();

            for (let i = 0; i < input.files.length; i++) {
                if (i !== index) dt.items.add(input.files[i]);
            }

            input.files = dt.files;
            displayAttachments();
        }

        // Toplu işlem yönetimi
        function updateBulkActions() {
            var selectedCount = $('.message-checkbox:checked').length;
            if (selectedCount > 0) {
                $('#btnBulkDelete').removeClass('d-none');
                $('#selectedCount').text(selectedCount);
            } else {
                $('#btnBulkDelete').addClass('d-none');
            }
        }

        // Toplu silme
        function deleteSelected() {
            if(!confirm("Seçili mesajları silmek istediğinize emin misiniz?")) return;

            var selectedIds = [];
            $('.message-checkbox:checked').each(function() {
                selectedIds.push(parseInt($(this).val()));
            });

            fetch('/Message/DeleteMultiple', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(selectedIds)
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert("Silme işlemi başarısız oldu.");
                }
            });
        }

        // Seçilileri okundu işaretle
        function markSelectedAsRead() {
            var selectedIds = [];
            $('.message-checkbox:checked').each(function() {
                selectedIds.push(parseInt($(this).val()));
            });

            if (selectedIds.length === 0) {
                alert("Lütfen en az bir mesaj seçin.");
                return;
            }

            selectedIds.forEach(id => {
                fetch('/Message/MarkAsRead?messageId=' + id, { method: 'POST' })
                .then(() => location.reload());
            });
        }

        // Yıldızlama
        function toggleStar(element, messageId) {
            event.stopPropagation();
            if(element.classList.contains('bx-star')) {
                element.classList.remove('bx-star', 'text-muted');
                element.classList.add('bxs-star', 'text-warning');
            } else {
                element.classList.remove('bxs-star', 'text-warning');
                element.classList.add('bx-star', 'text-muted');
            }
            fetch('/Message/ToggleStar/' + messageId, { method: 'POST' });
        }

        // Okunmamış sayıyı güncelle
        function updateUnreadCount() {
            fetch('/Message/GetUnreadCount')
            .then(response => response.json())
            .then(data => {
                $('.unread-badge').text(data.count);
            });
        }
    </script>
}
